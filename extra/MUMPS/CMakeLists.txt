cmake_minimum_required(VERSION 3.0.2)

project(MUMPS)
enable_language(Fortran)

find_package(ZLIB REQUIRED)
find_package(MPI  REQUIRED)

set(LINK_FLAGS "-fPIC -fopenmp")

if (APPLE)
    set(SHARED_SC_COMPILE_FLAGS "-fPIC ")
    set(SHARED_SC_LINK_FLAGS_1 "-Wl,-force_load")
    set(SHARED_SC_LINK_FLAGS_2 "")
    set(CMAKE_BUILD_WITH_INSTALL_NAME_DIR true)  # this writes full path using install_name_dir  
else()
    set(SHARED_SC_COMPILE_FLAGS "-fPIC")
    set(SHARED_SC_LINK_FLAGS_1 "-Wl,-whole-archive")
    set(SHARED_SC_LINK_FLAGS_2 "-Wl,-no-whole-archive")
endif()

set( MUMPS_COMMON_STATIC ${CMAKE_CURRENT_LIST_DIR}/lib/libmumps_common.a )
set( ZMUMPS_STATIC ${CMAKE_CURRENT_LIST_DIR}/lib/libzmumps.a )
set( SMUMPS_STATIC ${CMAKE_CURRENT_LIST_DIR}/lib/libsmumps.a )
set( DMUMPS_STATIC ${CMAKE_CURRENT_LIST_DIR}/lib/libdmumps.a )
set( CMUMPS_STATIC ${CMAKE_CURRENT_LIST_DIR}/lib/libcmumps.a )
set( PORD_STATIC ${CMAKE_CURRENT_LIST_DIR}/lib/libpord.a )


# Create an empty cpp file to use as a stand-in for cpp sources in the library
set (EMPTY_CPP ${CMAKE_CURRENT_BINARY_DIR}/empty.f)
file(WRITE ${EMPTY_CPP} "c     XS This is an empty file generated by cmake" )

# pord
add_library(pord SHARED ${EMPTY_CPP})
target_link_libraries(pord  ${SHARED_SC_LINK_FLAGS_1}
                            ${PORD_STATIC}
			    ${SHARED_SC_LINK_FLAGS_2} )
set_target_properties(pord PROPERTIES 
                      COMPILE_FLAGS ${SHARED_SC_COMPILE_FLAGS}
                      LINK_FLAGS ${LINK_FLAGS}
		      LINKER_LANGUAGE Fortran
                      OUTPUT_NAME pord )
install(TARGETS pord
        DESTINATION ${CMAKE_INSTALL_PREFIX}/lib
        )
	
# mumps_common
add_library(mumps_common SHARED ${EMPTY_CPP})
add_dependencies( mumps_common pord)
target_link_libraries(mumps_common  ${SHARED_SC_LINK_FLAGS_1}
                            ${MUMPS_COMMON_STATIC}
			    ${SHARED_SC_LINK_FLAGS_2}
    			    $<TARGET_FILE:pord>
			    -L${PARMETIS_LINK_DIR}
			    parmetis			    
			    -L${METIS_LINK_DIR}
			    metis
			    ${MPI_C_LIBRARIES} 
			    ${OpenMP_C_LIBRARIES} )			    

set_target_properties(mumps_common PROPERTIES 
                      COMPILE_FLAGS ${SHARED_SC_COMPILE_FLAGS}
                      LINK_FLAGS ${LINK_FLAGS}
		      LINKER_LANGUAGE Fortran		      
                      OUTPUT_NAME mumps_common )
install(TARGETS mumps_common
        DESTINATION ${CMAKE_INSTALL_PREFIX}/lib
        )

# zmumps
add_library(zmumps SHARED ${EMPTY_CPP})
add_dependencies( zmumps mumps_common pord)
target_link_libraries(zmumps ${SHARED_SC_LINK_FLAGS_1}
                             ${ZMUMPS_STATIC}
 			     ${SHARED_SC_LINK_FLAGS_2}
       			     $<TARGET_FILE:mumps_common>
       			     $<TARGET_FILE:pord>
			     ${LAPACK_FLAGS})

set_target_properties(zmumps PROPERTIES 
                      COMPILE_FLAGS ${SHARED_SC_COMPILE_FLAGS}
                      LINK_FLAGS ${LINK_FLAGS}
		      LINKER_LANGUAGE Fortran		      
                      OUTPUT_NAME zmumps )
install(TARGETS zmumps
        DESTINATION ${CMAKE_INSTALL_PREFIX}/lib
        )

# dmumps
add_library(dmumps SHARED ${EMPTY_CPP})
add_dependencies( dmumps mumps_common pord)
target_link_libraries(dmumps ${SHARED_SC_LINK_FLAGS_1}
                             ${DMUMPS_STATIC}
 			     ${SHARED_SC_LINK_FLAGS_2}
       			     $<TARGET_FILE:mumps_common>
       			     $<TARGET_FILE:pord>
			     ${LAPACK_FLAGS})

set_target_properties(dmumps PROPERTIES 
                      COMPILE_FLAGS ${SHARED_SC_COMPILE_FLAGS}
                      LINK_FLAGS ${LINK_FLAGS}		      
		      LINKER_LANGUAGE Fortran		      
                      OUTPUT_NAME dmumps )
install(TARGETS dmumps
        DESTINATION ${CMAKE_INSTALL_PREFIX}/lib
        )

# smumps
add_library(smumps SHARED ${EMPTY_CPP})
add_dependencies( smumps mumps_common pord)
target_link_libraries(smumps ${SHARED_SC_LINK_FLAGS_1}
                             ${SMUMPS_STATIC}
 			     ${SHARED_SC_LINK_FLAGS_2}
       			     $<TARGET_FILE:mumps_common>
       			     $<TARGET_FILE:pord>
			     ${LAPACK_FLAGS})

set_target_properties(smumps PROPERTIES 
                      COMPILE_FLAGS ${SHARED_SC_COMPILE_FLAGS}
                      LINK_FLAGS ${LINK_FLAGS}		      
		      LINKER_LANGUAGE Fortran		      
                      OUTPUT_NAME smumps )
install(TARGETS smumps
        DESTINATION ${CMAKE_INSTALL_PREFIX}/lib
        )

# cmumps
add_library(cmumps SHARED ${EMPTY_CPP})
add_dependencies( cmumps mumps_common pord)
target_link_libraries(cmumps ${SHARED_SC_LINK_FLAGS_1}
                             ${CMUMPS_STATIC}
 			     ${SHARED_SC_LINK_FLAGS_2}
       			     $<TARGET_FILE:mumps_common>
       			     $<TARGET_FILE:pord>
			     ${LAPACK_FLAGS})

set_target_properties(cmumps PROPERTIES 
                      COMPILE_FLAGS ${SHARED_SC_COMPILE_FLAGS}
                      LINK_FLAGS ${LINK_FLAGS}		      
		      LINKER_LANGUAGE Fortran		      
                      OUTPUT_NAME cmumps )
install(TARGETS cmumps
        DESTINATION ${CMAKE_INSTALL_PREFIX}/lib
        )

